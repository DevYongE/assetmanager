#!/bin/bash

# =============================================================================
# QR ìì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ìë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.
# PM2ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  nginxë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
#
# ì£¼ìš” ê¸°ëŠ¥:
# - ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
# - í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
# - PM2 í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬
# - nginx ì„¤ì • ì ìš©
# - SSL ì¸ì¦ì„œ í™•ì¸
#
# ì‘ì„±ì¼: 2025-01-27
# =============================================================================

echo "ğŸš€ QR ìì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

# =============================================================================
# 1. SSL ì¸ì¦ì„œ í™•ì¸
# =============================================================================
echo "ğŸ”’ SSL ì¸ì¦ì„œë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."

if [ ! -f "/etc/letsencrypt/live/invenone.it.kr/fullchain.pem" ]; then
    echo "âŒ SSL ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: /etc/letsencrypt/live/invenone.it.kr/fullchain.pem"
    echo "âš ï¸  Let's Encrypt ì¸ì¦ì„œë¥¼ ë¨¼ì € ì„¤ì¹˜í•´ì£¼ì„¸ìš”."
    exit 1
fi

if [ ! -f "/etc/letsencrypt/live/invenone.it.kr/privkey.pem" ]; then
    echo "âŒ SSL ê°œì¸í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: /etc/letsencrypt/live/invenone.it.kr/privkey.pem"
    echo "âš ï¸  Let's Encrypt ì¸ì¦ì„œë¥¼ ë¨¼ì € ì„¤ì¹˜í•´ì£¼ì„¸ìš”."
    exit 1
fi

echo "âœ… SSL ì¸ì¦ì„œê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."

# =============================================================================
# 2. ë°±ì—”ë“œ ë°°í¬
# =============================================================================
echo "ğŸ”§ ë°±ì—”ë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."

cd backend

# ì˜ì¡´ì„± ì„¤ì¹˜
echo "ğŸ“¦ ë°±ì—”ë“œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
npm install

# PM2ë¡œ ë°±ì—”ë“œ ì‹œì‘
echo "ğŸš€ ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
pm2 delete backend 2>/dev/null || true
pm2 start index.js --name backend --watch

echo "âœ… ë°±ì—”ë“œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

# =============================================================================
# 3. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
# =============================================================================
echo "ğŸ”§ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."

cd ../frontend

# ì˜ì¡´ì„± ì„¤ì¹˜
echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
npm install

# í”„ë¡œë•ì…˜ ë¹Œë“œ
echo "ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
npm run build

# PM2ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘
echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
pm2 delete frontend 2>/dev/null || true
pm2 start npm --name frontend -- run preview

echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

# =============================================================================
# 4. nginx ì„¤ì • ì ìš©
# =============================================================================
echo "ğŸŒ nginx ì„¤ì •ì„ ì ìš©í•©ë‹ˆë‹¤..."

# nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
sudo cp ../nginx.conf /etc/nginx/nginx.conf

# nginx ì„¤ì • í…ŒìŠ¤íŠ¸
echo "ğŸ” nginx ì„¤ì •ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤..."
if sudo nginx -t; then
    echo "âœ… nginx ì„¤ì •ì´ ìœ íš¨í•©ë‹ˆë‹¤."
    
    # nginx ì¬ì‹œì‘
    echo "ğŸ”„ nginxë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
    sudo systemctl restart nginx
    
    # nginx ìƒíƒœ í™•ì¸
    if sudo systemctl is-active --quiet nginx; then
        echo "âœ… nginxê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
    else
        echo "âŒ nginx ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        exit 1
    fi
else
    echo "âŒ nginx ì„¤ì •ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤."
    exit 1
fi

# =============================================================================
# 5. ë°©í™”ë²½ ì„¤ì • í™•ì¸
# =============================================================================
echo "ğŸ”¥ ë°©í™”ë²½ ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤..."

# HTTPS í¬íŠ¸(443) í™•ì¸
if sudo ufw status | grep -q "443"; then
    echo "âœ… HTTPS í¬íŠ¸(443)ê°€ ì—´ë ¤ìˆìŠµë‹ˆë‹¤."
else
    echo "âš ï¸ HTTPS í¬íŠ¸(443)ë¥¼ ì—´ì–´ì£¼ì„¸ìš”: sudo ufw allow 443"
fi

# HTTP í¬íŠ¸(80) í™•ì¸
if sudo ufw status | grep -q "80"; then
    echo "âœ… HTTP í¬íŠ¸(80)ê°€ ì—´ë ¤ìˆìŠµë‹ˆë‹¤."
else
    echo "âš ï¸ HTTP í¬íŠ¸(80)ë¥¼ ì—´ì–´ì£¼ì„¸ìš”: sudo ufw allow 80"
fi

# =============================================================================
# 6. ë°°í¬ ì™„ë£Œ ë° í™•ì¸
# =============================================================================
echo ""
echo "ğŸ‰ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo ""
echo "ğŸ“‹ ë°°í¬ ì •ë³´:"
echo "   ğŸŒ ì›¹ì‚¬ì´íŠ¸: https://invenone.it.kr"
echo "   ğŸ”— API ì„œë²„: https://invenone.it.kr/api"
echo "   ğŸ“Š í—¬ìŠ¤ì²´í¬: https://invenone.it.kr/api/health"
echo ""
echo "ğŸ”§ ê´€ë¦¬ ëª…ë ¹ì–´:"
echo "   PM2 ìƒíƒœ í™•ì¸: pm2 status"
echo "   PM2 ë¡œê·¸ í™•ì¸: pm2 logs"
echo "   nginx ìƒíƒœ í™•ì¸: sudo systemctl status nginx"
echo "   nginx ë¡œê·¸ í™•ì¸: sudo tail -f /var/log/nginx/error.log"
echo ""
echo "âš ï¸  ì£¼ì˜ì‚¬í•­:"
echo "   - SSL ì¸ì¦ì„œëŠ” 90ì¼ë§ˆë‹¤ ê°±ì‹ ì´ í•„ìš”í•©ë‹ˆë‹¤"
echo "   - Let's Encrypt ê°±ì‹ : sudo certbot renew"
echo "   - nginx ì„¤ì • ë³€ê²½ í›„: sudo systemctl reload nginx"
echo ""

# PM2 ìƒíƒœ ì¶œë ¥
echo "ğŸ“Š í˜„ì¬ PM2 í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
pm2 status

echo ""
echo "âœ… ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" 