#!/bin/bash

# =============================================================================
# useAuthStore Import ë¬¸ì œ í•´ê²° ìŠ¤í¬ë¦½íŠ¸
# =============================================================================

echo "ğŸ”§ useAuthStore import ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤..."
echo ""

# =============================================================================
# 1. í˜„ì¬ ìƒíƒœ í™•ì¸
# =============================================================================
echo "ğŸ“‹ 1ë‹¨ê³„: í˜„ì¬ ìƒíƒœ í™•ì¸"

echo "PM2 ìƒíƒœ í™•ì¸..."
pm2 status

echo ""
echo "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ í™•ì¸..."
ls -la frontend/.output/server/ 2>/dev/null || echo "âŒ ë¹Œë“œ íŒŒì¼ ì—†ìŒ"

echo ""

# =============================================================================
# 2. í”„ë¡ íŠ¸ì—”ë“œ ì¬ë¹Œë“œ
# =============================================================================
echo "ğŸ”¨ 2ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì¬ë¹Œë“œ"

echo "í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™..."
cd frontend

echo "ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì •ë¦¬..."
rm -rf .output
rm -rf .nuxt

echo "ì˜ì¡´ì„± í™•ì¸..."
npm list --depth=0 | grep -E "(nuxt|pinia|@pinia)" || echo "í•„ìˆ˜ íŒ¨í‚¤ì§€ ì—†ìŒ"

echo ""
echo "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘..."
NODE_ENV=production npm run build

if [ $? -eq 0 ]; then
    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì„±ê³µ"
else
    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨"
    exit 1
fi

cd ..

echo ""

# =============================================================================
# 3. PM2 ì¬ì‹œì‘
# =============================================================================
echo "âš™ï¸ 3ë‹¨ê³„: PM2 ì¬ì‹œì‘"

echo "ê¸°ì¡´ PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€..."
pm2 stop all
pm2 delete all

echo "PM2 ì„¤ì • í™•ì¸..."
if [ -f "ecosystem.config.js" ]; then
    echo "âœ… ecosystem.config.js ì¡´ì¬"
else
    echo "âŒ ecosystem.config.js ì—†ìŒ - ìƒì„±í•©ë‹ˆë‹¤"
    cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'backend',
      script: 'index.js',
      cwd: './backend',
      instances: 1,
      autorestart: true,
      watch: false,
      env: {
        NODE_ENV: 'production',
        PORT: 4000
      }
    },
    {
      name: 'frontend',
      script: '.output/server/index.mjs',
      cwd: './frontend',
      instances: 1,
      autorestart: true,
      watch: false,
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      }
    }
  ]
};
EOF
fi

echo "PM2ë¡œ ì‹œì‘..."
pm2 start ecosystem.config.js

echo "PM2 ìƒíƒœ í™•ì¸..."
pm2 status

echo ""

# =============================================================================
# 4. ì„œë²„ í…ŒìŠ¤íŠ¸
# =============================================================================
echo "ğŸ§ª 4ë‹¨ê³„: ì„œë²„ í…ŒìŠ¤íŠ¸"

echo "5ì´ˆ ëŒ€ê¸°..."
sleep 5

echo "ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸..."
curl -I http://localhost:4000/api/health 2>/dev/null && echo "âœ… ë°±ì—”ë“œ ì •ìƒ" || echo "âŒ ë°±ì—”ë“œ ì‹¤íŒ¨"

echo "í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸..."
curl -I http://localhost:3000 2>/dev/null && echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì •ìƒ" || echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì‹¤íŒ¨"

echo ""

# =============================================================================
# 5. Caddy ì¬ì‹œì‘
# =============================================================================
echo "ğŸŒ 5ë‹¨ê³„: Caddy ì¬ì‹œì‘"

echo "Caddy ì¬ì‹œì‘..."
sudo systemctl restart caddy

echo "Caddy ìƒíƒœ í™•ì¸..."
sudo systemctl status caddy --no-pager

echo ""

# =============================================================================
# 6. ìµœì¢… í…ŒìŠ¤íŠ¸
# =============================================================================
echo "ğŸ¯ 6ë‹¨ê³„: ìµœì¢… í…ŒìŠ¤íŠ¸"

echo "í¬íŠ¸ ìƒíƒœ í™•ì¸:"
sudo netstat -tlnp | grep -E ':(80|443|3000|4000)'

echo ""
echo "ì›¹ì‚¬ì´íŠ¸ í…ŒìŠ¤íŠ¸..."
curl -I https://invenone.it.kr 2>/dev/null && echo "âœ… ì›¹ì‚¬ì´íŠ¸ ì •ìƒ" || echo "âŒ ì›¹ì‚¬ì´íŠ¸ ì‹¤íŒ¨"

echo ""

# =============================================================================
# 7. ì™„ë£Œ
# =============================================================================
echo "ğŸ‰ useAuthStore ë¬¸ì œ í•´ê²° ì™„ë£Œ!"
echo ""
echo "ğŸ“‹ í™•ì¸ ì‚¬í•­:"
echo "   1. ë¸Œë¼ìš°ì €ì—ì„œ https://invenone.it.kr ì ‘ì†"
echo "   2. ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ í›„ ì¬ì ‘ì† (Ctrl+F5)"
echo "   3. ê°œë°œì ë„êµ¬ì—ì„œ Console íƒ­ í™•ì¸"
echo ""
echo "ğŸ”§ ê´€ë¦¬ ëª…ë ¹ì–´:"
echo "   PM2 ìƒíƒœ: pm2 status"
echo "   PM2 ë¡œê·¸: pm2 logs"
echo "   Caddy ìƒíƒœ: sudo systemctl status caddy"
echo "   Caddy ë¡œê·¸: sudo journalctl -u caddy -f"
echo ""
echo "âœ… ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" 