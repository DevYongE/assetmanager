#!/bin/bash

# =============================================================================
# ê°•ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” nginx ì„¤ì •ì„ ê°•ì œë¡œ êµì²´í•˜ê³ 
# ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì™„ì „íˆ ì¬ë°°í¬í•©ë‹ˆë‹¤.
# ê¸°ë³¸ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ëŒ€ì‹  ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í‘œì‹œí•©ë‹ˆë‹¤.
#
# ì‘ì„±ì¼: 2025-01-27
# =============================================================================

echo "ğŸš€ ê°•ì œ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
echo ""

# =============================================================================
# 1. ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
# =============================================================================
echo "â¹ï¸ ëª¨ë“  í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."

# PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
pm2 delete all 2>/dev/null || true

# nginx ì¤‘ì§€
sudo systemctl stop nginx

echo "âœ… ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"

# =============================================================================
# 2. ë°±ì—”ë“œ ë°°í¬
# =============================================================================
echo "ğŸ”§ ë°±ì—”ë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."

cd backend

# ì˜ì¡´ì„± ì„¤ì¹˜
echo "ğŸ“¦ ë°±ì—”ë“œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
npm install

# PM2ë¡œ ë°±ì—”ë“œ ì‹œì‘
echo "ğŸš€ ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
pm2 start index.js --name backend --watch

cd ..
echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"

# =============================================================================
# 3. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
# =============================================================================
echo "ğŸ”§ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."

cd frontend

# ì˜ì¡´ì„± ì„¤ì¹˜
echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
npm install

# í”„ë¡œë•ì…˜ ë¹Œë“œ
echo "ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
npm run build

# PM2ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘
echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
pm2 start npm --name frontend -- run preview

cd ..
echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"

# =============================================================================
# 4. íŒŒì¼ ê¶Œí•œ ì„¤ì •
# =============================================================================
echo "ğŸ” íŒŒì¼ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤..."

if [ -d "frontend/.output/public" ]; then
    sudo chown -R nginx:nginx frontend/.output/public/
    sudo chmod -R 755 frontend/.output/public/
    echo "âœ… íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
else
    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    exit 1
fi

# =============================================================================
# 5. nginx ì„¤ì • ê°•ì œ êµì²´
# =============================================================================
echo "ğŸŒ nginx ì„¤ì •ì„ ê°•ì œë¡œ êµì²´í•©ë‹ˆë‹¤..."

# ê¸°ì¡´ ì„¤ì • ë°±ì—…
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup

# ìƒˆ ì„¤ì • ì ìš©
sudo cp nginx.conf /etc/nginx/nginx.conf

# nginx ì„¤ì • í…ŒìŠ¤íŠ¸
echo "ğŸ” nginx ì„¤ì •ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤..."
if sudo nginx -t; then
    echo "âœ… nginx ì„¤ì • ìœ íš¨"
else
    echo "âŒ nginx ì„¤ì • ì˜¤ë¥˜"
    echo "ë°±ì—…ì—ì„œ ë³µì›í•©ë‹ˆë‹¤..."
    sudo cp /etc/nginx/nginx.conf.backup /etc/nginx/nginx.conf
    exit 1
fi

# nginx ì‹œì‘
echo "ğŸ”„ nginxë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
sudo systemctl start nginx

# nginx ìƒíƒœ í™•ì¸
if sudo systemctl is-active --quiet nginx; then
    echo "âœ… nginx ì‹œì‘ ì™„ë£Œ"
else
    echo "âŒ nginx ì‹œì‘ ì‹¤íŒ¨"
    exit 1
fi

# =============================================================================
# 6. ë°©í™”ë²½ ì„¤ì • í™•ì¸
# =============================================================================
echo "ğŸ”¥ ë°©í™”ë²½ ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤..."

# í•„ìš”í•œ í¬íŠ¸ ì—´ê¸°
sudo ufw allow 80 2>/dev/null || true
sudo ufw allow 443 2>/dev/null || true
sudo ufw allow 3000 2>/dev/null || true
sudo ufw allow 4000 2>/dev/null || true

echo "âœ… ë°©í™”ë²½ ì„¤ì • ì™„ë£Œ"

# =============================================================================
# 7. ìƒíƒœ í™•ì¸
# =============================================================================
echo "ğŸ“Š ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."

echo "PM2 í”„ë¡œì„¸ìŠ¤:"
pm2 status

echo ""
echo "í¬íŠ¸ ìƒíƒœ:"
sudo netstat -tlnp | grep -E ':(80|443|3000|4000)'

echo ""
echo "nginx ìƒíƒœ:"
sudo systemctl status nginx --no-pager

# =============================================================================
# 8. í…ŒìŠ¤íŠ¸
# =============================================================================
echo "ğŸ§ª ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤..."

echo "HTTP í…ŒìŠ¤íŠ¸:"
curl -I http://invenone.it.kr

echo ""
echo "HTTPS í…ŒìŠ¤íŠ¸:"
curl -I -k https://invenone.it.kr

echo ""
echo "API í…ŒìŠ¤íŠ¸:"
curl -I -k https://invenone.it.kr/api/health

# =============================================================================
# 9. ì™„ë£Œ
# =============================================================================
echo ""
echo "ğŸ‰ ê°•ì œ ë°°í¬ ì™„ë£Œ!"
echo ""
echo "ğŸ“‹ í™•ì¸ ì‚¬í•­:"
echo "   1. ë¸Œë¼ìš°ì €ì—ì„œ https://invenone.it.kr ì ‘ì†"
echo "   2. ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ í›„ ì¬ì ‘ì† (Ctrl+F5)"
echo "   3. ê°œë°œì ë„êµ¬ì—ì„œ ì˜¤ë¥˜ í™•ì¸"
echo ""
echo "ğŸŒ ì ‘ì† URL:"
echo "   ì›¹ì‚¬ì´íŠ¸: https://invenone.it.kr"
echo "   API ì„œë²„: https://invenone.it.kr/api"
echo "   í—¬ìŠ¤ì²´í¬: https://invenone.it.kr/api/health"
echo ""
echo "âœ… ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" 