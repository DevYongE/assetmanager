#!/bin/bash

# =============================================================================
# PM2 중복 프로세스 정리 스크립트
# =============================================================================

echo "🔧 PM2 중복 프로세스를 정리합니다..."
echo ""

# =============================================================================
# 1. 현재 상태 확인
# =============================================================================
echo "📋 1단계: 현재 상태 확인"

echo "dmanager 사용자 PM2 상태:"
pm2 list

echo ""
echo "root 사용자 PM2 상태:"
sudo pm2 list

echo ""

# =============================================================================
# 2. root 사용자 PM2 프로세스 정리
# =============================================================================
echo "🔧 2단계: root 사용자 PM2 프로세스 정리"

echo "root 사용자의 모든 PM2 프로세스 중지 및 삭제..."
sudo pm2 stop all
sudo pm2 delete all
sudo pm2 kill

echo "root 사용자 PM2 상태 확인:"
sudo pm2 list

echo ""

# =============================================================================
# 3. dmanager 사용자 PM2 프로세스 확인
# =============================================================================
echo "📋 3단계: dmanager 사용자 PM2 프로세스 확인"

echo "dmanager 사용자 PM2 상태:"
pm2 list

echo ""

# =============================================================================
# 4. 서버 연결 테스트
# =============================================================================
echo "🧪 4단계: 서버 연결 테스트"

echo "5초 대기..."
sleep 5

echo "백엔드 테스트 (포트 4000):"
curl -I http://localhost:4000/api/health 2>/dev/null && echo "✅ 백엔드 정상" || echo "❌ 백엔드 실패"

echo ""
echo "프론트엔드 테스트 (포트 3000):"
curl -I http://localhost:3000 2>/dev/null && echo "✅ 프론트엔드 정상" || echo "❌ 프론트엔드 실패"

echo ""

# =============================================================================
# 5. 포트 상태 확인
# =============================================================================
echo "🌐 5단계: 포트 상태 확인"

echo "현재 열린 포트:"
sudo netstat -tlnp | grep -E ':(80|443|3000|4000)'

echo ""

# =============================================================================
# 6. Nginx 재시작
# =============================================================================
echo "🌐 6단계: Nginx 재시작"

echo "Nginx 설정 테스트..."
sudo nginx -t

echo "Nginx 재시작..."
sudo systemctl restart nginx

echo "Nginx 상태 확인..."
sudo systemctl status nginx --no-pager

echo ""

# =============================================================================
# 7. 최종 테스트
# =============================================================================
echo "🎯 7단계: 최종 테스트"

echo "웹사이트 테스트..."
curl -I https://invenone.it.kr 2>/dev/null && echo "✅ 웹사이트 정상" || echo "❌ 웹사이트 실패"

echo ""

# =============================================================================
# 8. 완료
# =============================================================================
echo "🎉 PM2 중복 프로세스 정리 완료!"
echo ""
echo "📋 현재 상태:"
echo "   - dmanager 사용자 PM2 프로세스만 실행 중"
echo "   - root 사용자 PM2 프로세스 정리됨"
echo ""
echo "📋 확인 사항:"
echo "   1. 브라우저에서 https://invenone.it.kr 접속"
echo "   2. 브라우저 캐시 삭제 후 재접속 (Ctrl+F5)"
echo "   3. 개발자 도구에서 Console 탭 확인"
echo ""
echo "🔧 관리 명령어:"
echo "   PM2 상태: pm2 status"
echo "   PM2 로그: pm2 logs"
echo "   Nginx 상태: sudo systemctl status nginx"
echo "   Nginx 로그: sudo tail -f /var/log/nginx/error.log"
echo ""
echo "✅ 모든 설정이 완료되었습니다!" 