#!/bin/bash

# =============================================================================
# μ„λ²„ μƒνƒ ν™•μΈ μ¤ν¬λ¦½νΈ
# =============================================================================
#
# μ΄ μ¤ν¬λ¦½νΈλ” ν„μ¬ μ„λ²„μ μƒνƒλ¥Ό ν™•μΈν•©λ‹λ‹¤.
# nginx, PM2, SSL μΈμ¦μ„, ν¬νΈ μƒνƒ λ“±μ„ μ κ²€ν•©λ‹λ‹¤.
#
# μ‘μ„±μΌ: 2025-01-27
# =============================================================================

echo "π” μ„λ²„ μƒνƒλ¥Ό ν™•μΈν•©λ‹λ‹¤..."
echo ""

# =============================================================================
# 1. SSL μΈμ¦μ„ ν™•μΈ
# =============================================================================
echo "π”’ SSL μΈμ¦μ„ μƒνƒ:"
if [ -f "/etc/letsencrypt/live/invenone.it.kr/fullchain.pem" ]; then
    echo "β… SSL μΈμ¦μ„ νμΌ μ΅΄μ¬"
    echo "   μ„μΉ: /etc/letsencrypt/live/invenone.it.kr/fullchain.pem"
else
    echo "β SSL μΈμ¦μ„ νμΌ μ—†μ"
fi

if [ -f "/etc/letsencrypt/live/invenone.it.kr/privkey.pem" ]; then
    echo "β… SSL κ°μΈν‚¤ νμΌ μ΅΄μ¬"
    echo "   μ„μΉ: /etc/letsencrypt/live/invenone.it.kr/privkey.pem"
else
    echo "β SSL κ°μΈν‚¤ νμΌ μ—†μ"
fi
echo ""

# =============================================================================
# 2. nginx μƒνƒ ν™•μΈ
# =============================================================================
echo "π nginx μƒνƒ:"
if systemctl is-active --quiet nginx; then
    echo "β… nginx μ‹¤ν–‰ μ¤‘"
else
    echo "β nginx μ¤‘μ§€λ¨"
fi

echo "nginx μ„¤μ • ν…μ¤νΈ:"
if sudo nginx -t 2>/dev/null; then
    echo "β… nginx μ„¤μ • μ ν¨"
else
    echo "β nginx μ„¤μ • μ¤λ¥"
fi
echo ""

# =============================================================================
# 3. PM2 ν”„λ΅μ„Έμ¤ ν™•μΈ
# =============================================================================
echo "π“ PM2 ν”„λ΅μ„Έμ¤ μƒνƒ:"
if command -v pm2 &> /dev/null; then
    pm2 status
else
    echo "β PM2κ°€ μ„¤μΉλμ§€ μ•μ"
fi
echo ""

# =============================================================================
# 4. ν¬νΈ μƒνƒ ν™•μΈ
# =============================================================================
echo "π” ν¬νΈ μƒνƒ:"
echo "ν¬νΈ 80 (HTTP):"
if sudo netstat -tlnp | grep -q ":80 "; then
    echo "β… ν¬νΈ 80 μ—΄λ¦Ό"
else
    echo "β ν¬νΈ 80 λ‹«ν"
fi

echo "ν¬νΈ 443 (HTTPS):"
if sudo netstat -tlnp | grep -q ":443 "; then
    echo "β… ν¬νΈ 443 μ—΄λ¦Ό"
else
    echo "β ν¬νΈ 443 λ‹«ν"
fi

echo "ν¬νΈ 3000 (ν”„λ΅ νΈμ—”λ“):"
if sudo netstat -tlnp | grep -q ":3000 "; then
    echo "β… ν¬νΈ 3000 μ—΄λ¦Ό"
else
    echo "β ν¬νΈ 3000 λ‹«ν"
fi

echo "ν¬νΈ 4000 (λ°±μ—”λ“):"
if sudo netstat -tlnp | grep -q ":4000 "; then
    echo "β… ν¬νΈ 4000 μ—΄λ¦Ό"
else
    echo "β ν¬νΈ 4000 λ‹«ν"
fi
echo ""

# =============================================================================
# 5. μ• ν”λ¦¬μΌ€μ΄μ… νμΌ ν™•μΈ
# =============================================================================
echo "π“ μ• ν”λ¦¬μΌ€μ΄μ… νμΌ ν™•μΈ:"
echo "ν”„λ΅ νΈμ—”λ“ λΉλ“ νμΌ:"
if [ -d "/home/dmanager/assetmanager/frontend/.output/public/_nuxt" ]; then
    echo "β… ν”„λ΅ νΈμ—”λ“ λΉλ“ νμΌ μ΅΄μ¬"
    ls -la /home/dmanager/assetmanager/frontend/.output/public/_nuxt/ | head -5
else
    echo "β ν”„λ΅ νΈμ—”λ“ λΉλ“ νμΌ μ—†μ"
fi

echo "λ°±μ—”λ“ νμΌ:"
if [ -f "/home/dmanager/assetmanager/backend/index.js" ]; then
    echo "β… λ°±μ—”λ“ νμΌ μ΅΄μ¬"
else
    echo "β λ°±μ—”λ“ νμΌ μ—†μ"
fi
echo ""

# =============================================================================
# 6. nginx μ„¤μ • ν™•μΈ
# =============================================================================
echo "β™οΈ nginx μ„¤μ • ν™•μΈ:"
echo "ν„μ¬ nginx μ„¤μ • νμΌ:"
if [ -f "/etc/nginx/nginx.conf" ]; then
    echo "β… nginx.conf νμΌ μ΅΄μ¬"
    echo "μ„¤μ • λ‚΄μ© (μΌλ¶€):"
    head -20 /etc/nginx/nginx.conf
else
    echo "β nginx.conf νμΌ μ—†μ"
fi
echo ""

# =============================================================================
# 7. λ°©ν™”λ²½ μƒνƒ ν™•μΈ
# =============================================================================
echo "π”¥ λ°©ν™”λ²½ μƒνƒ:"
if command -v ufw &> /dev/null; then
    echo "UFW μƒνƒ:"
    sudo ufw status
else
    echo "UFWκ°€ μ„¤μΉλμ§€ μ•μ"
fi
echo ""

echo "π” μƒνƒ ν™•μΈ μ™„λ£!"
echo ""
echo "π’΅ λ‹¤μ λ‹¨κ³„:"
echo "1. PM2 ν”„λ΅μ„Έμ¤κ°€ μ‹¤ν–‰λμ§€ μ•μ•λ‹¤λ©΄: ./deploy.sh μ‹¤ν–‰"
echo "2. nginx μ„¤μ •μ΄ μλ»λμ—λ‹¤λ©΄: nginx.conf νμΌ ν™•μΈ"
echo "3. ν¬νΈκ°€ λ‹«ν€μλ‹¤λ©΄: λ°©ν™”λ²½ μ„¤μ • ν™•μΈ" 