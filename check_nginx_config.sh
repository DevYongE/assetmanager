#!/bin/bash

# =============================================================================
# nginx 설정 확인 스크립트
# =============================================================================
#
# 이 스크립트는 nginx 설정을 확인하고
# 왜 기본 테스트 페이지가 나오는지 진단합니다.
#
# 작성일: 2025-01-27
# =============================================================================

echo "🔍 nginx 설정을 확인합니다..."
echo ""

# =============================================================================
# 1. 현재 nginx 설정 확인
# =============================================================================
echo "📄 현재 nginx 설정:"
echo "----------------------------------------"
sudo cat /etc/nginx/nginx.conf
echo "----------------------------------------"

echo ""

# =============================================================================
# 2. nginx 설정 테스트
# =============================================================================
echo "🔍 nginx 설정 테스트:"
if sudo nginx -t; then
    echo "✅ nginx 설정 유효"
else
    echo "❌ nginx 설정 오류"
fi

echo ""

# =============================================================================
# 3. nginx 상태 확인
# =============================================================================
echo "📊 nginx 상태:"
sudo systemctl status nginx --no-pager

echo ""

# =============================================================================
# 4. 포트 확인
# =============================================================================
echo "🔌 포트 상태:"
sudo netstat -tlnp | grep -E ':(80|443|3000|4000)'

echo ""

# =============================================================================
# 5. PM2 프로세스 확인
# =============================================================================
echo "📊 PM2 프로세스:"
pm2 status

echo ""

# =============================================================================
# 6. 애플리케이션 파일 확인
# =============================================================================
echo "📁 애플리케이션 파일 확인:"

echo "프론트엔드 빌드 파일:"
if [ -d "frontend/.output/public/_nuxt" ]; then
    echo "✅ 프론트엔드 빌드 파일 존재"
    ls -la frontend/.output/public/_nuxt/ | head -5
else
    echo "❌ 프론트엔드 빌드 파일 없음"
fi

echo "백엔드 파일:"
if [ -f "backend/index.js" ]; then
    echo "✅ 백엔드 파일 존재"
else
    echo "❌ 백엔드 파일 없음"
fi

echo ""

# =============================================================================
# 7. nginx 로그 확인
# =============================================================================
echo "📋 nginx 로그 확인:"

echo "최근 오류 로그:"
sudo tail -10 /var/log/nginx/error.log

echo ""
echo "최근 접근 로그:"
sudo tail -10 /var/log/nginx/access.log

echo ""

# =============================================================================
# 8. 직접 테스트
# =============================================================================
echo "🧪 직접 테스트:"

echo "HTTP 요청 테스트:"
curl -I http://invenone.it.kr

echo ""
echo "HTTPS 요청 테스트:"
curl -I -k https://invenone.it.kr

echo ""

# =============================================================================
# 9. 문제 해결 제안
# =============================================================================
echo "💡 문제 해결 제안:"

echo "1. nginx 설정 파일 교체:"
echo "   sudo cp nginx.conf /etc/nginx/nginx.conf"
echo ""

echo "2. nginx 재시작:"
echo "   sudo systemctl restart nginx"
echo ""

echo "3. PM2 프로세스 재시작:"
echo "   pm2 restart all"
echo ""

echo "4. 파일 권한 설정:"
echo "   sudo chown -R nginx:nginx frontend/.output/public/"
echo ""

echo "5. 방화벽 확인:"
echo "   sudo ufw status"
echo ""

echo "🔍 진단 완료!" 