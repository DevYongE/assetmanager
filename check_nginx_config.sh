#!/bin/bash

# =============================================================================
# nginx ì„¤ì • í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” nginx ì„¤ì •ì„ í™•ì¸í•˜ê³ 
# ì™œ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë‚˜ì˜¤ëŠ”ì§€ ì§„ë‹¨í•©ë‹ˆë‹¤.
#
# ì‘ì„±ì¼: 2025-01-27
# =============================================================================

echo "ğŸ” nginx ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤..."
echo ""

# =============================================================================
# 1. í˜„ì¬ nginx ì„¤ì • í™•ì¸
# =============================================================================
echo "ğŸ“„ í˜„ì¬ nginx ì„¤ì •:"
echo "----------------------------------------"
sudo cat /etc/nginx/nginx.conf
echo "----------------------------------------"

echo ""

# =============================================================================
# 2. nginx ì„¤ì • í…ŒìŠ¤íŠ¸
# =============================================================================
echo "ğŸ” nginx ì„¤ì • í…ŒìŠ¤íŠ¸:"
if sudo nginx -t; then
    echo "âœ… nginx ì„¤ì • ìœ íš¨"
else
    echo "âŒ nginx ì„¤ì • ì˜¤ë¥˜"
fi

echo ""

# =============================================================================
# 3. nginx ìƒíƒœ í™•ì¸
# =============================================================================
echo "ğŸ“Š nginx ìƒíƒœ:"
sudo systemctl status nginx --no-pager

echo ""

# =============================================================================
# 4. í¬íŠ¸ í™•ì¸
# =============================================================================
echo "ğŸ”Œ í¬íŠ¸ ìƒíƒœ:"
sudo netstat -tlnp | grep -E ':(80|443|3000|4000)'

echo ""

# =============================================================================
# 5. PM2 í”„ë¡œì„¸ìŠ¤ í™•ì¸
# =============================================================================
echo "ğŸ“Š PM2 í”„ë¡œì„¸ìŠ¤:"
pm2 status

echo ""

# =============================================================================
# 6. ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ í™•ì¸
# =============================================================================
echo "ğŸ“ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ í™•ì¸:"

echo "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼:"
if [ -d "frontend/.output/public/_nuxt" ]; then
    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ì¡´ì¬"
    ls -la frontend/.output/public/_nuxt/ | head -5
else
    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ì—†ìŒ"
fi

echo "ë°±ì—”ë“œ íŒŒì¼:"
if [ -f "backend/index.js" ]; then
    echo "âœ… ë°±ì—”ë“œ íŒŒì¼ ì¡´ì¬"
else
    echo "âŒ ë°±ì—”ë“œ íŒŒì¼ ì—†ìŒ"
fi

echo ""

# =============================================================================
# 7. nginx ë¡œê·¸ í™•ì¸
# =============================================================================
echo "ğŸ“‹ nginx ë¡œê·¸ í™•ì¸:"

echo "ìµœê·¼ ì˜¤ë¥˜ ë¡œê·¸:"
sudo tail -10 /var/log/nginx/error.log

echo ""
echo "ìµœê·¼ ì ‘ê·¼ ë¡œê·¸:"
sudo tail -10 /var/log/nginx/access.log

echo ""

# =============================================================================
# 8. ì§ì ‘ í…ŒìŠ¤íŠ¸
# =============================================================================
echo "ğŸ§ª ì§ì ‘ í…ŒìŠ¤íŠ¸:"

echo "HTTP ìš”ì²­ í…ŒìŠ¤íŠ¸:"
curl -I http://invenone.it.kr

echo ""
echo "HTTPS ìš”ì²­ í…ŒìŠ¤íŠ¸:"
curl -I -k https://invenone.it.kr

echo ""

# =============================================================================
# 9. ë¬¸ì œ í•´ê²° ì œì•ˆ
# =============================================================================
echo "ğŸ’¡ ë¬¸ì œ í•´ê²° ì œì•ˆ:"

echo "1. nginx ì„¤ì • íŒŒì¼ êµì²´:"
echo "   sudo cp nginx.conf /etc/nginx/nginx.conf"
echo ""

echo "2. nginx ì¬ì‹œì‘:"
echo "   sudo systemctl restart nginx"
echo ""

echo "3. PM2 í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘:"
echo "   pm2 restart all"
echo ""

echo "4. íŒŒì¼ ê¶Œí•œ ì„¤ì •:"
echo "   sudo chown -R nginx:nginx frontend/.output/public/"
echo ""

echo "5. ë°©í™”ë²½ í™•ì¸:"
echo "   sudo ufw status"
echo ""

echo "ğŸ” ì§„ë‹¨ ì™„ë£Œ!" 