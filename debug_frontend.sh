#!/bin/bash

# =============================================================================
# í”„ë¡ íŠ¸ì—”ë“œ ë””ë²„ê¹… ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.
# ë¹Œë“œ íŒŒì¼, í¬íŠ¸, nginx ì„¤ì • ë“±ì„ í™•ì¸í•©ë‹ˆë‹¤.
#
# ì‘ì„±ì¼: 2025-01-27
# =============================================================================

echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤..."
echo ""

# =============================================================================
# 1. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ í™•ì¸
# =============================================================================
echo "ğŸ“ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ í™•ì¸:"

if [ -d "frontend/.output/public/_nuxt" ]; then
    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ì¡´ì¬"
    echo "ğŸ“„ ë¹Œë“œ íŒŒì¼ ëª©ë¡:"
    ls -la frontend/.output/public/_nuxt/ | head -10
else
    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ì—†ìŒ"
    echo "ğŸ’¡ í•´ê²°: npm run build ì‹¤í–‰ í•„ìš”"
fi

echo ""

# =============================================================================
# 2. PM2 í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì„¸ìŠ¤ í™•ì¸
# =============================================================================
echo "ğŸ“Š PM2 í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì„¸ìŠ¤ í™•ì¸:"
pm2 status

echo ""

# =============================================================================
# 3. í¬íŠ¸ ìƒíƒœ í™•ì¸
# =============================================================================
echo "ğŸ”Œ í¬íŠ¸ ìƒíƒœ í™•ì¸:"

echo "í¬íŠ¸ 3000 (í”„ë¡ íŠ¸ì—”ë“œ):"
if sudo netstat -tlnp | grep -q ":3000 "; then
    echo "âœ… í¬íŠ¸ 3000 ì—´ë¦¼"
    sudo netstat -tlnp | grep ":3000"
else
    echo "âŒ í¬íŠ¸ 3000 ë‹«í˜"
fi

echo "í¬íŠ¸ 443 (HTTPS):"
if sudo netstat -tlnp | grep -q ":443 "; then
    echo "âœ… í¬íŠ¸ 443 ì—´ë¦¼"
    sudo netstat -tlnp | grep ":443"
else
    echo "âŒ í¬íŠ¸ 443 ë‹«í˜"
fi

echo ""

# =============================================================================
# 4. nginx ì„¤ì • í™•ì¸
# =============================================================================
echo "ğŸŒ nginx ì„¤ì • í™•ì¸:"

echo "nginx ìƒíƒœ:"
if systemctl is-active --quiet nginx; then
    echo "âœ… nginx ì‹¤í–‰ ì¤‘"
else
    echo "âŒ nginx ì¤‘ì§€ë¨"
fi

echo "nginx ì„¤ì • í…ŒìŠ¤íŠ¸:"
if sudo nginx -t 2>/dev/null; then
    echo "âœ… nginx ì„¤ì • ìœ íš¨"
else
    echo "âŒ nginx ì„¤ì • ì˜¤ë¥˜"
fi

echo ""

# =============================================================================
# 5. nginx ë¡œê·¸ í™•ì¸
# =============================================================================
echo "ğŸ“‹ nginx ë¡œê·¸ í™•ì¸:"
echo "ìµœê·¼ ì˜¤ë¥˜ ë¡œê·¸:"
sudo tail -10 /var/log/nginx/error.log

echo ""
echo "ìµœê·¼ ì ‘ê·¼ ë¡œê·¸:"
sudo tail -10 /var/log/nginx/access.log

echo ""

# =============================================================================
# 6. í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì§ì ‘ í…ŒìŠ¤íŠ¸
# =============================================================================
echo "ğŸ§ª í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì§ì ‘ í…ŒìŠ¤íŠ¸:"

echo "curlë¡œ localhost:3000 í…ŒìŠ¤íŠ¸:"
if curl -s http://localhost:3000 > /dev/null; then
    echo "âœ… localhost:3000 ì‘ë‹µí•¨"
else
    echo "âŒ localhost:3000 ì‘ë‹µ ì•ˆí•¨"
fi

echo "curlë¡œ HTTPS í…ŒìŠ¤íŠ¸:"
if curl -s -k https://invenone.it.kr > /dev/null; then
    echo "âœ… https://invenone.it.kr ì‘ë‹µí•¨"
else
    echo "âŒ https://invenone.it.kr ì‘ë‹µ ì•ˆí•¨"
fi

echo ""

# =============================================================================
# 7. íŒŒì¼ ê¶Œí•œ í™•ì¸
# =============================================================================
echo "ğŸ” íŒŒì¼ ê¶Œí•œ í™•ì¸:"

if [ -d "frontend/.output/public/_nuxt" ]; then
    echo "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ê¶Œí•œ:"
    ls -la frontend/.output/public/_nuxt/ | head -5
    
    echo ""
    echo "nginx ì‚¬ìš©ì í™•ì¸:"
    ps aux | grep nginx | head -3
fi

echo ""

# =============================================================================
# 8. ë¬¸ì œ í•´ê²° ì œì•ˆ
# =============================================================================
echo "ğŸ’¡ ë¬¸ì œ í•´ê²° ì œì•ˆ:"

echo "1. í”„ë¡ íŠ¸ì—”ë“œ ì¬ë¹Œë“œ:"
echo "   cd frontend"
echo "   npm run build"
echo ""

echo "2. PM2 í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘:"
echo "   pm2 delete frontend"
echo "   pm2 start npm --name frontend -- run preview"
echo ""

echo "3. nginx ì¬ì‹œì‘:"
echo "   sudo systemctl restart nginx"
echo ""

echo "4. íŒŒì¼ ê¶Œí•œ ìˆ˜ì •:"
echo "   sudo chown -R nginx:nginx frontend/.output/public/"
echo "   sudo chmod -R 755 frontend/.output/public/"
echo ""

echo "5. ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ í›„ ì¬ì ‘ì†"
echo ""

echo "ğŸ” ì§„ë‹¨ ì™„ë£Œ!" 