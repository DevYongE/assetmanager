// =============================================================================
// QR 자산관리 시스템 통합 PM2 설정 파일
// =============================================================================
//
// 이 파일은 PM2 프로세스 매니저를 사용하여 백엔드와 프론트엔드 서비스를
// 함께 관리하는 설정 파일입니다. 서버 재부팅 시 자동 시작, 로그 관리,
// 메모리 제한, 자동 재시작 등의 기능을 제공합니다.
//
// 주요 기능:
// - 백엔드 서비스 관리 (Express.js)
// - 프론트엔드 서비스 관리 (Nuxt.js)
// - 자동 재시작 및 복구
// - 로그 파일 관리
// - 메모리 사용량 제한
// - 환경별 설정 분리
//
// 작성일: 2025-01-27
// =============================================================================

module.exports = {
  apps: [
    // =============================================================================
    // 백엔드 서비스 설정 (Express.js)
    // =============================================================================
    {
      name: 'assetmanager-backend',        // 서비스 이름 (PM2에서 식별용)
      script: './backend/index.js',        // 실행할 스크립트 파일
      cwd: './backend',                    // 작업 디렉토리
      instances: 1,                        // 인스턴스 수 (단일 인스턴스)
      autorestart: true,                   // 자동 재시작 활성화
      watch: false,                        // 파일 변경 감지 비활성화 (운영 환경)
      max_memory_restart: '1G',           // 메모리 사용량 제한 (1GB)
      
      // =============================================================================
      // 로그 파일 설정
      // =============================================================================
      error_file: './logs/backend-error.log',    // 에러 로그 파일
      out_file: './logs/backend-out.log',        // 표준 출력 로그 파일
      log_file: './logs/backend-combined.log',   // 통합 로그 파일
      time: true,                                // 로그에 타임스탬프 추가
      
      // =============================================================================
      // 개발 환경 설정
      // =============================================================================
      env: {
        NODE_ENV: 'development',           // 개발 환경 플래그
        PORT: 4000                         // 백엔드 서버 포트
      },
      
      // =============================================================================
      // 운영 환경 설정
      // =============================================================================
      env_production: {
        NODE_ENV: 'production',            // 운영 환경 플래그
        PORT: 4000                         // 백엔드 서버 포트
      },
      
      // =============================================================================
      // 자동 재시작 설정
      // =============================================================================
      restart_delay: 4000,                 // 재시작 전 대기 시간 (4초)
      max_restarts: 10,                    // 최대 재시작 횟수
      min_uptime: '10s'                   // 최소 가동 시간 (안정성 판단 기준)
    },
    
    // =============================================================================
    // 프론트엔드 서비스 설정 (Nuxt.js)
    // =============================================================================
    {
      name: 'assetmanager-frontend',       // 서비스 이름 (PM2에서 식별용)
      script: 'node_modules/nuxt/bin/nuxt.js',  // Nuxt.js 실행 파일
      args: 'start',                       // Nuxt.js 시작 명령어
      cwd: './frontend',                   // 작업 디렉토리
      instances: 1,                        // 인스턴스 수 (단일 인스턴스)
      autorestart: true,                   // 자동 재시작 활성화
      watch: false,                        // 파일 변경 감지 비활성화 (운영 환경)
      max_memory_restart: '1G',           // 메모리 사용량 제한 (1GB)
      
      // =============================================================================
      // 로그 파일 설정
      // =============================================================================
      error_file: './logs/frontend-error.log',   // 에러 로그 파일
      out_file: './logs/frontend-out.log',       // 표준 출력 로그 파일
      log_file: './logs/frontend-combined.log',  // 통합 로그 파일
      time: true,                                 // 로그에 타임스탬프 추가
      
      // =============================================================================
      // 개발 환경 설정
      // =============================================================================
      env: {
        NODE_ENV: 'development',           // 개발 환경 플래그
        PORT: 3000,                        // 프론트엔드 서버 포트
        API_BASE_URL: 'http://localhost:4000'  // 개발 환경 API URL
      },
      
      // =============================================================================
      // 운영 환경 설정
      // =============================================================================
      env_production: {
        NODE_ENV: 'production',            // 운영 환경 플래그
        PORT: 3000,                        // 프론트엔드 서버 포트
        API_BASE_URL: 'https://invenone.it.kr'  // 운영 환경 API URL
      },
      
      // =============================================================================
      // 자동 재시작 설정
      // =============================================================================
      restart_delay: 4000,                 // 재시작 전 대기 시간 (4초)
      max_restarts: 10,                    // 최대 재시작 횟수
      min_uptime: '10s'                   // 최소 가동 시간 (안정성 판단 기준)
    }
  ]
}; 