#!/bin/bash

# =============================================================================
# ë¹ ë¥¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹ ë¥´ê²Œ ë°°í¬í•©ë‹ˆë‹¤.
# ê¸°ë³¸ nginx í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ëŒ€ì‹  ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
#
# ì‘ì„±ì¼: 2025-01-27
# =============================================================================

echo "ğŸš€ ë¹ ë¥¸ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

# =============================================================================
# 1. í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸
# =============================================================================
echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"

# =============================================================================
# 2. ë°±ì—”ë“œ ë°°í¬
# =============================================================================
echo "ğŸ”§ ë°±ì—”ë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."

if [ -d "backend" ]; then
    cd backend
    
    # ì˜ì¡´ì„± ì„¤ì¹˜
    echo "ğŸ“¦ ë°±ì—”ë“œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
    npm install
    
    # PM2ë¡œ ë°±ì—”ë“œ ì‹œì‘
    echo "ğŸš€ ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
    pm2 delete backend 2>/dev/null || true
    pm2 start index.js --name backend --watch
    
    cd ..
    echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"
else
    echo "âŒ backend ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    exit 1
fi

# =============================================================================
# 3. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
# =============================================================================
echo "ğŸ”§ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."

if [ -d "frontend" ]; then
    cd frontend
    
    # ì˜ì¡´ì„± ì„¤ì¹˜
    echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
    npm install
    
    # í”„ë¡œë•ì…˜ ë¹Œë“œ
    echo "ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
    npm run build
    
    # PM2ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘
    echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
    pm2 delete frontend 2>/dev/null || true
    pm2 start npm --name frontend -- run preview
    
    cd ..
    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"
else
    echo "âŒ frontend ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    exit 1
fi

# =============================================================================
# 4. nginx ì„¤ì • ì ìš©
# =============================================================================
echo "ğŸŒ nginx ì„¤ì •ì„ ì ìš©í•©ë‹ˆë‹¤..."

if [ -f "nginx.conf" ]; then
    # nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
    sudo cp nginx.conf /etc/nginx/nginx.conf
    
    # nginx ì„¤ì • í…ŒìŠ¤íŠ¸
    echo "ğŸ” nginx ì„¤ì •ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤..."
    if sudo nginx -t; then
        echo "âœ… nginx ì„¤ì •ì´ ìœ íš¨í•©ë‹ˆë‹¤."
        
        # nginx ì¬ì‹œì‘
        echo "ğŸ”„ nginxë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
        sudo systemctl restart nginx
        
        # nginx ìƒíƒœ í™•ì¸
        if sudo systemctl is-active --quiet nginx; then
            echo "âœ… nginxê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
        else
            echo "âŒ nginx ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            exit 1
        fi
    else
        echo "âŒ nginx ì„¤ì •ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤."
        exit 1
    fi
else
    echo "âŒ nginx.conf íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    exit 1
fi

# =============================================================================
# 5. ë°°í¬ ì™„ë£Œ í™•ì¸
# =============================================================================
echo ""
echo "ğŸ‰ ë¹ ë¥¸ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo ""
echo "ğŸ“‹ ë°°í¬ ì •ë³´:"
echo "   ğŸŒ ì›¹ì‚¬ì´íŠ¸: https://invenone.it.kr"
echo "   ğŸ”— API ì„œë²„: https://invenone.it.kr/api"
echo "   ğŸ“Š í—¬ìŠ¤ì²´í¬: https://invenone.it.kr/api/health"
echo ""
echo "ğŸ”§ í™•ì¸ ëª…ë ¹ì–´:"
echo "   PM2 ìƒíƒœ: pm2 status"
echo "   nginx ìƒíƒœ: sudo systemctl status nginx"
echo "   í¬íŠ¸ í™•ì¸: sudo netstat -tlnp | grep -E ':(80|443|3000|4000)'"
echo ""

# PM2 ìƒíƒœ ì¶œë ¥
echo "ğŸ“Š í˜„ì¬ PM2 í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
pm2 status

echo ""
echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ https://invenone.it.kr ì„ í™•ì¸í•´ë³´ì„¸ìš”!" 