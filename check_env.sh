#!/bin/bash

# =============================================================================
# í™˜ê²½ë³€ìˆ˜ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì„œë²„ì˜ .env íŒŒì¼ì„ í™•ì¸í•˜ê³ 
# Supabase ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ ì ê²€í•©ë‹ˆë‹¤.
#
# ì‘ì„±ì¼: 2025-01-27
# =============================================================================

echo "ğŸ” í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
echo ""

# =============================================================================
# 1. .env íŒŒì¼ ì¡´ì¬ í™•ì¸
# =============================================================================
echo "ğŸ“ .env íŒŒì¼ í™•ì¸:"

if [ -f "backend/.env" ]; then
    echo "âœ… backend/.env íŒŒì¼ ì¡´ì¬"
    echo "ğŸ“„ íŒŒì¼ ë‚´ìš©:"
    echo "----------------------------------------"
    cat backend/.env
    echo "----------------------------------------"
else
    echo "âŒ backend/.env íŒŒì¼ ì—†ìŒ"
fi

if [ -f ".env" ]; then
    echo "âœ… ë£¨íŠ¸ .env íŒŒì¼ ì¡´ì¬"
    echo "ğŸ“„ íŒŒì¼ ë‚´ìš©:"
    echo "----------------------------------------"
    cat .env
    echo "----------------------------------------"
else
    echo "âŒ ë£¨íŠ¸ .env íŒŒì¼ ì—†ìŒ"
fi

echo ""

# =============================================================================
# 2. í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ë° í™•ì¸
# =============================================================================
echo "ğŸ”§ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ:"

# .env íŒŒì¼ì´ ìˆë‹¤ë©´ ë¡œë“œ
if [ -f "backend/.env" ]; then
    echo "ğŸ“¥ backend/.env íŒŒì¼ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
    export $(cat backend/.env | grep -v '^#' | xargs)
elif [ -f ".env" ]; then
    echo "ğŸ“¥ ë£¨íŠ¸ .env íŒŒì¼ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
    export $(cat .env | grep -v '^#' | xargs)
fi

echo ""

# =============================================================================
# 3. Supabase ì„¤ì • í™•ì¸
# =============================================================================
echo "ğŸ” Supabase ì„¤ì • í™•ì¸:"

echo "SUPABASE_URL: ${SUPABASE_URL:-'NOT SET'}"
echo "SUPABASE_KEY: ${SUPABASE_KEY:-'NOT SET'}"
echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-'NOT SET'}"

if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
    echo "âœ… Supabase ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
else
    echo "âŒ Supabase ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
fi

echo ""

# =============================================================================
# 4. ê¸°íƒ€ í™˜ê²½ë³€ìˆ˜ í™•ì¸
# =============================================================================
echo "âš™ï¸ ê¸°íƒ€ í™˜ê²½ë³€ìˆ˜ í™•ì¸:"

echo "NODE_ENV: ${NODE_ENV:-'NOT SET'}"
echo "PORT: ${PORT:-'NOT SET'}"
echo "JWT_SECRET: ${JWT_SECRET:-'NOT SET'}"

echo ""

# =============================================================================
# 5. ë°±ì—”ë“œ ì¬ì‹œì‘ ì•ˆë‚´
# =============================================================================
echo "ğŸ”„ ë°±ì—”ë“œ ì¬ì‹œì‘:"

if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
    echo "âœ… í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
    
    # ë°±ì—”ë“œ ì¬ì‹œì‘
    pm2 delete backend 2>/dev/null || true
    cd backend
    pm2 start index.js --name backend --watch
    cd ..
    
    echo "âœ… ë°±ì—”ë“œê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
else
    echo "âš ï¸ Supabase ì„¤ì •ì´ ëˆ„ë½ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
    echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
    echo "   1. backend/.env íŒŒì¼ì— Supabase ì„¤ì • ì¶”ê°€"
    echo "   2. ë˜ëŠ” ë£¨íŠ¸ .env íŒŒì¼ì— Supabase ì„¤ì • ì¶”ê°€"
    echo "   3. ì„¤ì • í›„: pm2 restart backend"
fi

echo ""
echo "ğŸ“Š í˜„ì¬ PM2 ìƒíƒœ:"
pm2 status 