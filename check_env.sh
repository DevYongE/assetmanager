#!/bin/bash

# =============================================================================
# 환경변수 확인 스크립트
# =============================================================================
#
# 이 스크립트는 서버의 .env 파일을 확인하고
# Supabase 설정이 올바른지 점검합니다.
#
# 작성일: 2025-01-27
# =============================================================================

echo "🔍 환경변수를 확인합니다..."
echo ""

# =============================================================================
# 1. .env 파일 존재 확인
# =============================================================================
echo "📁 .env 파일 확인:"

if [ -f "backend/.env" ]; then
    echo "✅ backend/.env 파일 존재"
    echo "📄 파일 내용:"
    echo "----------------------------------------"
    cat backend/.env
    echo "----------------------------------------"
else
    echo "❌ backend/.env 파일 없음"
fi

if [ -f ".env" ]; then
    echo "✅ 루트 .env 파일 존재"
    echo "📄 파일 내용:"
    echo "----------------------------------------"
    cat .env
    echo "----------------------------------------"
else
    echo "❌ 루트 .env 파일 없음"
fi

echo ""

# =============================================================================
# 2. 환경변수 로드 및 확인
# =============================================================================
echo "🔧 환경변수 로드:"

# .env 파일이 있다면 로드
if [ -f "backend/.env" ]; then
    echo "📥 backend/.env 파일을 로드합니다..."
    export $(cat backend/.env | grep -v '^#' | xargs)
elif [ -f ".env" ]; then
    echo "📥 루트 .env 파일을 로드합니다..."
    export $(cat .env | grep -v '^#' | xargs)
fi

echo ""

# =============================================================================
# 3. Supabase 설정 확인
# =============================================================================
echo "🔐 Supabase 설정 확인:"

echo "SUPABASE_URL: ${SUPABASE_URL:-'NOT SET'}"
echo "SUPABASE_KEY: ${SUPABASE_KEY:-'NOT SET'}"
echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-'NOT SET'}"

if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
    echo "✅ Supabase 설정이 완료되었습니다."
else
    echo "❌ Supabase 설정이 누락되었습니다."
fi

echo ""

# =============================================================================
# 4. 기타 환경변수 확인
# =============================================================================
echo "⚙️ 기타 환경변수 확인:"

echo "NODE_ENV: ${NODE_ENV:-'NOT SET'}"
echo "PORT: ${PORT:-'NOT SET'}"
echo "JWT_SECRET: ${JWT_SECRET:-'NOT SET'}"

echo ""

# =============================================================================
# 5. 백엔드 재시작 안내
# =============================================================================
echo "🔄 백엔드 재시작:"

if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
    echo "✅ 환경변수가 설정되어 있습니다. 백엔드를 재시작합니다..."
    
    # 백엔드 재시작
    pm2 delete backend 2>/dev/null || true
    cd backend
    pm2 start index.js --name backend --watch
    cd ..
    
    echo "✅ 백엔드가 재시작되었습니다."
else
    echo "⚠️ Supabase 설정이 누락되어 있습니다."
    echo "💡 해결 방법:"
    echo "   1. backend/.env 파일에 Supabase 설정 추가"
    echo "   2. 또는 루트 .env 파일에 Supabase 설정 추가"
    echo "   3. 설정 후: pm2 restart backend"
fi

echo ""
echo "📊 현재 PM2 상태:"
pm2 status 