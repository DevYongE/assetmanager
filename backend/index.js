// =============================================================================
// QR ìì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ë°±ì—”ë“œ ì„œë²„
// =============================================================================
//
// ì´ íŒŒì¼ì€ QR ìì‚°ê´€ë¦¬ ì‹œìŠ¤í…œì˜ ë°±ì—”ë“œ API ì„œë²„ì…ë‹ˆë‹¤.
// Express.jsë¥¼ ì‚¬ìš©í•˜ì—¬ RESTful APIë¥¼ ì œê³µí•˜ë©°,
// ì¸ì¦, ì§ì› ê´€ë¦¬, ì¥ë¹„ ê´€ë¦¬, QR ì½”ë“œ ìƒì„± ë“±ì˜ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
//
// ì£¼ìš” ê¸°ëŠ¥:
// - ì‚¬ìš©ì ì¸ì¦ (JWT í† í° ê¸°ë°˜)
// - ì§ì› ì •ë³´ ê´€ë¦¬ (CRUD)
// - ì¥ë¹„ ì •ë³´ ê´€ë¦¬ (CRUD)
// - QR ì½”ë“œ ìƒì„± ë° ê´€ë¦¬
// - Excel íŒŒì¼ import/export
// - ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
//
// ì‘ì„±ì¼: 2025-01-27
// =============================================================================

// í•„ìˆ˜ ëª¨ë“ˆ import
const express = require('express');        // ì›¹ í”„ë ˆì„ì›Œí¬
const cors = require('cors');              // CORS ì„¤ì •
const dotenv = require('dotenv');          // í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬
const path = require('path');              // íŒŒì¼ ê²½ë¡œ ì²˜ë¦¬

// HTTPS ê´€ë ¨ ëª¨ë“ˆ (í˜„ì¬ëŠ” ì£¼ì„ ì²˜ë¦¬ - HTTP ì‚¬ìš©)
// const https = require('https');
// const fs = require('fs');

// í™˜ê²½ë³€ìˆ˜ ë¡œë“œ (.env íŒŒì¼ì—ì„œ ì„¤ì • ì½ê¸°)
dotenv.config();

// Express ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const app = express();

// =============================================================================
// ì„œë²„ í¬íŠ¸ ì„¤ì •
// =============================================================================
// í™˜ê²½ë³€ìˆ˜ì—ì„œ í¬íŠ¸ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ 4000 ì‚¬ìš©
// 2025-01-27: ì„ì‹œë¡œ HTTP ì„œë²„ë¡œ ë³€ê²½ (SSL ì¸ì¦ì„œ ë¬¸ì œ í•´ê²°)
const PORT = process.env.PORT || 4000;

// =============================================================================
// CORS (Cross-Origin Resource Sharing) ì„¤ì •
// =============================================================================
// 2025-07-25: CORS ì„¤ì • ìˆ˜ì • - ëª¨ë°”ì¼ ì ‘ì†ì„ ìœ„í•´ ëª¨ë“  ë„ë©”ì¸ í—ˆìš©
const corsOptions = {
  origin: [
    'http://localhost:3000',
    'http://localhost:3002',
    'https://localhost:3000',
    'https://localhost:3002',
    'http://211.188.55.145:3000',
    'http://211.188.55.145:3002',
    'https://211.188.55.145:3000',
    'https://211.188.55.145:3002',
    'https://invenone.it.kr',
    'https://www.invenone.it.kr',
    'http://invenone.it.kr',
    'http://www.invenone.it.kr'
  ],
  credentials: true,  // ì¿ í‚¤/ì¸ì¦ ì •ë³´ í¬í•¨ í—ˆìš©
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],  // í—ˆìš©í•  HTTP ë©”ì„œë“œ
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Origin', 'Accept']  // í—ˆìš©í•  í—¤ë”
};

// =============================================================================
// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
// =============================================================================
// CORS ë¯¸ë“¤ì›¨ì–´ ì ìš©
app.use(cors(corsOptions));

// JSON ìš”ì²­ ë³¸ë¬¸ íŒŒì‹± (ìµœëŒ€ 10MB)
app.use(express.json({ limit: '10mb' }));

// URL ì¸ì½”ë”©ëœ ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±
app.use(express.urlencoded({ extended: true }));

// =============================================================================
// ë¼ìš°í„° ì„¤ì •
// =============================================================================
console.log('ğŸ”§ [BACKEND] Setting up routes...')

// ê° ê¸°ëŠ¥ë³„ ë¼ìš°í„°ë¥¼ /api ê²½ë¡œ í•˜ìœ„ì— ë§ˆìš´íŠ¸
app.use('/api/auth', require('./routes/auth'));      // ì¸ì¦ ê´€ë ¨ (ë¡œê·¸ì¸, íšŒì›ê°€ì…)
app.use('/api/users', require('./routes/users'));    // ì‚¬ìš©ì ê´€ë¦¬
app.use('/api/employees', require('./routes/employees')); // ì§ì› ê´€ë¦¬
app.use('/api/devices', require('./routes/devices')); // ì¥ë¹„ ê´€ë¦¬
app.use('/api/qr', require('./routes/qr'));         // QR ì½”ë“œ ìƒì„±

console.log('âœ… [BACKEND] Routes configured successfully')

// =============================================================================
// í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
// =============================================================================
// ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ìš© ì—”ë“œí¬ì¸íŠ¸ (ëª¨ë‹ˆí„°ë§, ë¡œë“œë°¸ëŸ°ì„œìš©)
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),  // ì„œë²„ ê°€ë™ ì‹œê°„
    environment: process.env.NODE_ENV || 'development'  // í˜„ì¬ í™˜ê²½
  })
})

// =============================================================================
// 404 ì—ëŸ¬ í•¸ë“¤ëŸ¬ (ì£¼ì„ ì²˜ë¦¬ë¨)
// =============================================================================
// path-to-regexp ì´ìŠˆ í•´ê²°ì„ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬
// app.all('*', (req, res) => {
//   res.status(404).json({ error: 'Route not found' });
// });

// =============================================================================
// ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
// =============================================================================
// ëª¨ë“  ë¼ìš°í„°ì—ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë¥¼ ì²˜ë¦¬
app.use((err, req, res, next) => {
  console.error(err.stack);  // ì—ëŸ¬ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ì¶œë ¥
  res.status(500).json({ error: 'Something went wrong!' });
});

// =============================================================================
// ì„œë²„ ì‹œì‘
// =============================================================================
// 2025-01-27: ì„ì‹œ HTTP ì„œë²„ë¡œ ë³€ê²½ (SSL ì¸ì¦ì„œ ë¬¸ì œ í•´ê²°)
app.listen(PORT, '0.0.0.0', () => {
  console.log('ğŸš€ [BACKEND] HTTP Server is running on port', PORT);
  console.log('ğŸŒ [BACKEND] Health check: http://0.0.0.0:' + PORT + '/health');
  console.log('ğŸ” [BACKEND] Auth endpoint: http://0.0.0.0:' + PORT + '/api/auth/login');
  console.log('âš ï¸ [BACKEND] Note: Running in HTTP mode (SSL certificate issue)');
});

// ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ ë‚´ë³´ë‚´ê¸° (í…ŒìŠ¤íŠ¸ìš©)
module.exports = app; 